# Deployment Guide (Vercel)

The project ships as a single Next.js application with Prisma + PostgreSQL and Azure OpenAI integrations. Follow this
checklist to promote the repo into a production-ready deployment on Vercel.

## 1. Prerequisites

1. **Vercel account** with permissions to create projects and manage environment variables.
2. **PostgreSQL instance**. Vercel Postgres (Neon) is recommended; any hosted Postgres 15+ works.
3. **Azure OpenAI resource** with a deployed GPT-4o/GPT-35 model for quiz generation.
4. (Optional but recommended) A WebSocket provider such as Pusher Channels or Ably for large-scale game broadcasting.

## 2. Environment Variables

Create a `.env` file locally (and mirror the same keys in Vercel → Project → Settings → Environment Variables):

```
DATABASE_URL="postgres://user:password@host:5432/db"
NEXTAUTH_SECRET="long_random_string"
JWT_SECRET="another_long_random_string"
AZURE_API_KEY="<azure-openai-key>"
AZURE_ENDPOINT="https://YOUR-RESOURCE.openai.azure.com"
AZURE_VERSION="2023-12-01-preview"
AZURE_MODEL="gpt-4o-mini"
FILE_STORAGE_BUCKET="vercel-blob://kahoot-ai"
REALTIME_PROVIDER="pusher"
PUSHER_KEY="..."
PUSHER_SECRET="..."
PUSHER_APP_ID="..."
```

> **Tip**: When using Vercel Postgres, copy the `DATABASE_URL` and `DIRECT_URL` generated by the dashboard and store both.

## 3. Local Development

```bash
npm install
cp .env.example .env # add secrets
npx prisma migrate dev
npm run dev
```

Open http://localhost:3000 to access the dashboard. The default account creation flow is email+password. Plan limits default
to the FREE tier until you edit the `PlanLimit` table.

## 4. Database Setup

1. Create the Postgres database (Vercel Postgres automatically provisions one per project).
2. Run migrations locally against the remote database to ensure schema parity:

```bash
DATABASE_URL="<remote-url>" npx prisma migrate deploy
```

3. (Optional) Seed plan limits via the helper script `npm run prisma:seed` (see README for details). The FREE plan is
inserted automatically by the migration.

## 5. Vercel Project Creation

1. Push your repo to GitHub/GitLab/Bitbucket.
2. On Vercel, click **New Project** → import the repository.
3. Set the **Root Directory** to the repository root.
4. Populate the environment variables listed above for **Production** and **Preview**.
5. Under **Build & Development Settings**, keep defaults (Build command `npm run build`, Install command `npm install`, Output directory `.next`).

## 6. Build Hooks & Prisma Migrations

Vercel automatically installs dependencies and runs `npm run build`. To ensure Prisma uses the production database:

1. Set `DATABASE_URL` and `DIRECT_URL` for every environment.
2. Add a post-deploy step (Vercel → Settings → Functions) or manual script to run migrations after each deploy:

```bash
vercel env pull .env.production
DATABASE_URL=$(grep DATABASE_URL .env.production | cut -d '=' -f2-) npx prisma migrate deploy
```

Alternatively, attach a GitHub Action that runs `npx prisma migrate deploy` against the production database after Vercel
reports a successful deployment.

## 7. Post-Deployment Validation Checklist

1. **User onboarding** – Sign up, verify login/logout, and confirm JWT cookies are issued.
2. **Quiz CRUD** – Create a manual quiz, add questions, publish, archive, and restore.
3. **AI generation** – Upload a small PDF or provide a URL to trigger an AI job. Ensure the status transitions to
   `COMPLETED` and a quiz appears in the editor.
4. **Game hosting** – Launch a game session, join with two browser windows, answer questions, and verify leaderboard
   updates.
5. **Limits** – Attempt to exceed the free plan thresholds and confirm helpful upgrade errors are displayed.

## 8. Scaling Guidance

* **Real-time** – For games exceeding ~100 concurrent players, use a managed WebSocket service. Configure provider keys as
  environment variables and update `src/server/realtime/pusher.ts` accordingly.
* **AI usage** – Track monthly AI quota resets via cron or scheduled functions (Vercel Cron). The `Usage` table already
  stores `period_start`/`period_end` values that can be extended.
* **Database** – Neon/Vercel Postgres autoscale storage but monitor connection limits. Prisma defaults to a single pool of
  connections per serverless function; reuse the exported Prisma client to avoid exhausting the pool.

Following this playbook ensures a smooth rollout on Vercel with observability and guardrails aligned with the PRDs.
